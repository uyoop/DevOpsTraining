global:
  resolve_timeout: 5m
  smtp_smarthost: '${ALERT_SMTP_HOST}'
  smtp_from: '${ALERT_SMTP_FROM}'
  smtp_auth_username: '${ALERT_SMTP_USERNAME}'
  smtp_auth_password: '${ALERT_SMTP_PASSWORD}'
  smtp_require_tls: true
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
  slack_api_url: '${SLACK_WEBHOOK_URL}'

templates:
  - '/etc/alertmanager/*.tmpl'

# Main routing tree
route:
  receiver: 'default-receiver'
  group_by: ['alertname', 'severity', 'environment']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 4h
  
  routes:
  # Critical alerts - immediate action required
  - match:
      severity: critical
    receiver: 'critical-pagerduty'
    group_wait: 10s
    repeat_interval: 1h
    continue: true
    
  - match:
      severity: critical
    receiver: 'critical-slack'
    group_wait: 10s
    repeat_interval: 1h
    continue: true
    
  - match:
      severity: critical
    receiver: 'critical-email'
    group_wait: 10s
    repeat_interval: 1h
  
  # Warning alerts - needs attention
  - match:
      severity: warning
    receiver: 'warning-slack'
    group_wait: 30s
    repeat_interval: 4h
    continue: true
    
  - match:
      severity: warning
    receiver: 'warning-email'
    group_wait: 30s
    repeat_interval: 4h
  
  # Info alerts - for awareness
  - match:
      severity: info
    receiver: 'info-slack'
    group_wait: 5m
    repeat_interval: 24h
  
  # Component-specific routing
  - match_re:
      component: database|redis|elasticsearch
    receiver: 'database-team'
    
  - match_re:
      component: frontend|api|web
    receiver: 'application-team'
    
  - match:
      component: network
    receiver: 'network-team'

# Notification receivers
receivers:
# Default receiver
- name: 'default-receiver'
  email_configs:
  - to: '${ALERT_SMTP_TO}'
    headers:
      Subject: '[Monitoring] {{ .GroupLabels.alertname }}'
    html: |
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          .alert { padding: 15px; margin: 10px 0; border-left: 4px solid; }
          .critical { border-color: #d32f2f; background: #ffebee; }
          .warning { border-color: #f57c00; background: #fff3e0; }
          .info { border-color: #1976d2; background: #e3f2fd; }
          .resolved { border-color: #388e3c; background: #e8f5e9; }
        </style>
      </head>
      <body>
        <h2>Alert Summary</h2>
        <p><strong>Environment:</strong> {{ .GroupLabels.environment }}</p>
        <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
        <p><strong>Status:</strong> {{ .Status }}</p>
        <hr>
        {{ range .Alerts }}
        <div class="alert {{ .Labels.severity }}">
          <h3>{{ .Labels.alertname }}</h3>
          <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          {{ if .Annotations.runbook_url }}
          <p><strong>Runbook:</strong> <a href="{{ .Annotations.runbook_url }}">{{ .Annotations.runbook_url }}</a></p>
          {{ end }}
          <p><strong>Started:</strong> {{ .StartsAt }}</p>
        </div>
        {{ end }}
      </body>
      </html>

# Critical alerts - PagerDuty
- name: 'critical-pagerduty'
  pagerduty_configs:
  - service_key: '${PAGERDUTY_SERVICE_KEY}'
    description: '{{ .GroupLabels.alertname }}: {{ .GroupLabels.instance }}'
    details:
      firing: '{{ .Alerts.Firing | len }}'
      resolved: '{{ .Alerts.Resolved | len }}'
      environment: '{{ .GroupLabels.environment }}'
    client: 'Prometheus Alertmanager'
    client_url: 'https://alertmanager.${DOMAIN}'

# Critical alerts - Slack
- name: 'critical-slack'
  slack_configs:
  - channel: '#alerts-critical'
    username: 'Alertmanager'
    icon_emoji: ':fire:'
    title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
    text: |
      *Environment:* {{ .GroupLabels.environment }}
      *Severity:* {{ .GroupLabels.severity }}
      *Status:* {{ .Status }}
      
      {{ range .Alerts }}
      *Instance:* {{ .Labels.instance }}
      *Description:* {{ .Annotations.description }}
      {{ if .Annotations.runbook_url }}
      *Runbook:* {{ .Annotations.runbook_url }}
      {{ end }}
      {{ end }}
    send_resolved: true
    color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

# Critical alerts - Email
- name: 'critical-email'
  email_configs:
  - to: 'oncall@example.com'
    send_resolved: true
    headers:
      Subject: 'üö® [CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.environment }}'
      Priority: 'urgent'

# Warning alerts - Slack
- name: 'warning-slack'
  slack_configs:
  - channel: '#alerts-warning'
    username: 'Alertmanager'
    icon_emoji: ':warning:'
    title: '‚ö†Ô∏è  WARNING: {{ .GroupLabels.alertname }}'
    text: |
      *Environment:* {{ .GroupLabels.environment }}
      *Status:* {{ .Status }}
      
      {{ range .Alerts }}
      *Instance:* {{ .Labels.instance }}
      *Description:* {{ .Annotations.description }}
      {{ end }}
    send_resolved: true
    color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

# Warning alerts - Email
- name: 'warning-email'
  email_configs:
  - to: 'team@example.com'
    send_resolved: true
    headers:
      Subject: '‚ö†Ô∏è  [WARNING] {{ .GroupLabels.alertname }}'

# Info alerts - Slack
- name: 'info-slack'
  slack_configs:
  - channel: '#alerts-info'
    username: 'Alertmanager'
    icon_emoji: ':information_source:'
    title: '‚ÑπÔ∏è  INFO: {{ .GroupLabels.alertname }}'
    text: |
      *Environment:* {{ .GroupLabels.environment }}
      {{ range .Alerts }}
      *Description:* {{ .Annotations.description }}
      {{ end }}
    send_resolved: false

# Database team
- name: 'database-team'
  slack_configs:
  - channel: '#db-alerts'
    username: 'Alertmanager'
    title: '{{ .GroupLabels.alertname }} - Database Alert'
    text: |
      {{ range .Alerts }}
      *Instance:* {{ .Labels.instance }}
      *Description:* {{ .Annotations.description }}
      {{ end }}
  email_configs:
  - to: 'db-team@example.com'

# Application team
- name: 'application-team'
  slack_configs:
  - channel: '#app-alerts'
    username: 'Alertmanager'
    title: '{{ .GroupLabels.alertname }} - Application Alert'
    text: |
      {{ range .Alerts }}
      *Instance:* {{ .Labels.instance }}
      *Description:* {{ .Annotations.description }}
      {{ end }}
  email_configs:
  - to: 'app-team@example.com'

# Network team
- name: 'network-team'
  slack_configs:
  - channel: '#network-alerts'
    username: 'Alertmanager'
    title: '{{ .GroupLabels.alertname }} - Network Alert'
    text: |
      {{ range .Alerts }}
      *Instance:* {{ .Labels.instance }}
      *Description:* {{ .Annotations.description }}
      {{ end }}
  email_configs:
  - to: 'network-team@example.com'

# Inhibition rules
inhibit_rules:
# Suppress warning if critical is firing
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['instance', 'alertname']

# Suppress all alerts if instance is down
- source_match:
    alertname: 'ProductionInstanceDown'
  target_match_re:
    alertname: '.*'
  equal: ['instance']

# Suppress container alerts if docker host is down
- source_match:
    alertname: 'ProductionInstanceDown'
  target_match_re:
    alertname: 'Container.*'
  equal: ['instance']

# Suppress service alerts if the service is down
- source_match:
    alertname: 'ServiceDown'
  target_match_re:
    alertname: '.*'
  equal: ['job', 'instance']
