# -*- mode: ruby -*-
# vi: set ft=ruby :

# Configuration VM Vagrant pour laboratoire Docker
# VM performante avec ressources suffisantes pour les TPs Docker
Vagrant.configure("2") do |config|
  # Box Ubuntu 22.04 LTS (Jammy) - Stable et bien supportée
  config.vm.box = "ubuntu/jammy64"
  config.vm.box_check_update = true
  
  # Nom de la VM
  config.vm.hostname = "docker-lab"
  
  # Configuration réseau - IP privée pour accès depuis l'hôte
  config.vm.network "private_network", ip: "192.168.56.123"
  
  # Ports forwarding pour services Docker courants
  # HTTP
  config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"
  # HTTPS
  config.vm.network "forwarded_port", guest: 443, host: 8443, host_ip: "127.0.0.1"
  # Port alternatif pour applications
  config.vm.network "forwarded_port", guest: 3000, host: 3000, host_ip: "127.0.0.1"
  config.vm.network "forwarded_port", guest: 8000, host: 8000, host_ip: "127.0.0.1"
  # PostgreSQL
  config.vm.network "forwarded_port", guest: 5432, host: 5432, host_ip: "127.0.0.1"
  # MySQL/MariaDB
  config.vm.network "forwarded_port", guest: 3306, host: 3306, host_ip: "127.0.0.1"
  # MongoDB
  config.vm.network "forwarded_port", guest: 27017, host: 27017, host_ip: "127.0.0.1"
  # Redis
  config.vm.network "forwarded_port", guest: 6379, host: 6379, host_ip: "127.0.0.1"
  
  # Dossier partagé pour échanger des fichiers avec l'hôte
  # Désactivé par défaut pour de meilleures performances
  # config.vm.synced_folder "./shared", "/vagrant_shared", create: true
  
  # Configuration VirtualBox - Ressources optimisées pour Docker
  config.vm.provider "virtualbox" do |vb|
    # Nom de la VM dans VirtualBox
    vb.name = "docker-lab-tp"
    
    # Interface graphique désactivée (mode headless)
    vb.gui = false
    
    # Ressources CPU - 2 vCPUs pour bonnes performances
    vb.cpus = 2
    
    # Mémoire RAM - 4 GB recommandés pour Docker (minimum 2 GB)
    vb.memory = "4096"
    
    # Optimisations VirtualBox pour meilleures performances
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
    vb.customize ["modifyvm", :id, "--nictype1", "virtio"]
    vb.customize ["modifyvm", :id, "--nictype2", "virtio"]
    
    # Activer la virtualisation imbriquée si supportée (pour Docker dans Docker)
    vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
  end
  
  # Provisionnement initial avec un script shell
  # Met à jour le système et installe les dépendances de base
  config.vm.provision "shell", inline: <<-SHELL
    echo "=== Mise à jour du système ==="
    apt-get update
    apt-get upgrade -y
    
    echo "=== Installation des outils de base ==="
    apt-get install -y \
      vim \
      curl \
      wget \
      git \
      tree \
      htop \
      net-tools \
      python3 \
      python3-pip
    
    echo "=== Configuration terminée ==="
    echo "Utilisez 'ansible-playbook -i inventory.ini install_docker.yml' pour installer Docker"
  SHELL
  
  # Message d'information post-démarrage
  config.vm.post_up_message = <<-MESSAGE
  ╔═══════════════════════════════════════════════════════════════╗
  ║         VM Docker Lab prête pour les TPs                      ║
  ╠═══════════════════════════════════════════════════════════════╣
  ║  Hostname: docker-lab                                         ║
  ║  IP: 192.168.56.123                                          ║
  ║  RAM: 4 GB                                                    ║
  ║  CPU: 2 vCPUs                                                ║
  ╠═══════════════════════════════════════════════════════════════╣
  ║  Prochaine étape:                                            ║
  ║  ansible-playbook -i inventory.ini install_docker.yml        ║
  ╚═══════════════════════════════════════════════════════════════╝
  MESSAGE
end
