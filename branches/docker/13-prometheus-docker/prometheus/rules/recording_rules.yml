groups:
- name: recording_rules
  interval: 1m
  rules:
  # Pre-compute CPU usage for faster queries
  - record: node:cpu_usage:avg5m
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

  # Pre-compute memory usage percentage
  - record: node:memory_usage:percent
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

  # Pre-compute disk usage percentage
  - record: node:disk_usage:percent
    expr: (node_filesystem_size_bytes{fstype=~"ext4|xfs"} - node_filesystem_free_bytes{fstype=~"ext4|xfs"}) / node_filesystem_size_bytes{fstype=~"ext4|xfs"} * 100

  # Pre-compute container CPU usage
  - record: container:cpu_usage:avg5m
    expr: sum by(name) (rate(container_cpu_usage_seconds_total{name!=""}[5m])) * 100

  # Pre-compute container memory usage percentage
  - record: container:memory_usage:percent
    expr: (container_memory_usage_bytes{name!=""} / container_spec_memory_limit_bytes{name!=""}) * 100

  # Pre-compute total container count
  - record: container:count:total
    expr: count(container_last_seen{name!=""})

  # Pre-compute running container count
  - record: container:count:running
    expr: count(container_last_seen{name!=""} > 0)

  # Pre-compute network receive rate per container
  - record: container:network_receive:rate5m
    expr: sum by(name) (rate(container_network_receive_bytes_total{name!=""}[5m]))

  # Pre-compute network transmit rate per container
  - record: container:network_transmit:rate5m
    expr: sum by(name) (rate(container_network_transmit_bytes_total{name!=""}[5m]))

  # Pre-compute disk I/O read rate per container
  - record: container:disk_read:rate5m
    expr: sum by(name) (rate(container_fs_reads_bytes_total{name!=""}[5m]))

  # Pre-compute disk I/O write rate per container
  - record: container:disk_write:rate5m
    expr: sum by(name) (rate(container_fs_writes_bytes_total{name!=""}[5m]))

  # Pre-compute system load normalized by CPU count
  - record: node:load_normalized:load5
    expr: node_load5 / count(node_cpu_seconds_total{mode="idle"}) without(cpu, mode)
